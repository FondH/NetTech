#### 路由器程序设计

1. 核心功能
   - 接受数据包，根据链路层Type进行拆卸网络层协议。对于ARP（0x0806）和IP（0x0800）

   - 对于ARP包，进行单播回复；由于虚拟机上实现，可能收到跨网段的ARP，需要进行过滤。

   - 对于IP包，根据路由表匹配规则对应转发；（进行转发前设计发送ARP得到mac）

     

2. 程序设计

   1. 全局：路由表、ARP缓存、数据包缓冲区、device
   2. 路由表：链表，顺序查找
   3. ARP缓存表： 哈希（u_int --> mac），便于直接查找
   4. 数据包缓冲区：队列，push和pop

3. 程序流程

   1. 路由器起码有两个INC，连接两个不同的网段；
   2. 抓取线程抓取来自各自网段数据包，过滤校验和通过、目的Mac为自己的数据包（广播报文仅考虑ARP的请求报文）；若是IP包，则继续将目的IP不是自己的数据包`push`进全局的数据包缓冲区；
   3. 处理线程依次从全局数据包缓冲区取数据
      - 验证TTL，对0的抛弃
      - 进行路由表规则匹配，进行转发。



